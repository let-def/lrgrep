\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{fontspec,amsmath,amsfonts}
\usepackage[a4paper, total={6in, 8in}]{geometry}
\usepackage{tikz}
%\usepackage{tikz-dependency}

\setmainfont{Optima}

\title{LRGrep manual \\
  Notes on the semantics of LRGrep regular expression}
\author{Frédéric Bour}

\begin{document}

\maketitle

\section{The LRgrep dialect}

\subsection{Context-Free Grammar}

Let $G = (N, T, R, S)$ a context-free grammar. We note:
\begin{itemize}
  \item $A, B \in N$, the non-terminals
  \item $a, b \in T$, the terminals
  \item $x \in \Sigma = N \cup T$, the symbols
  \item $\alpha, \beta, \gamma \in \Sigma^*$, the sententials forms; a sentential form made only of terminals is called a sentence
  \item $A \rightarrow \alpha \in R$, the rules or productions
  \item $S \in N$ the start symbol
\end{itemize}

The derivation relation $\alpha\Rightarrow\beta$ is the smallest relation such that $\alpha B \gamma \Rightarrow \alpha\beta\gamma$ for each $B\rightarrow \beta \in R$.
The language generated by $G$ is $L(G) = \{w \in T^*\ |\ S \Rightarrow^* w\}$, the set of all sentences that can be derived  from the start symbol.

\subsubsection{Viable prefixes of right sentential forms}


The viable prefixes of right sentential forms is the set of sentential forms that can appear on the stack of a shift-reduce parser.
To precisely characterize this set, we consider the grammar $G' = (N', \Sigma, R', S')$. Note that the non-terminals of $G$ are among the terminals of $G'$. The other sets are defined as follow:
\begin{itemize}
  \item $N' = \{ A' | A \in N \}$, the non-terminals of $G'$ are a duplicate of $N$ tagged with a quote
  \item $R' = \{ A' \rightarrow \alpha\ |\ A \rightarrow \alpha\beta \in R\}
         \cup \{ A' \rightarrow \alpha B'\ |\ A \rightarrow \alpha B \beta \in R\}$, a rule of $G'$ is either a prefix of a rule of $G$, with non-terminals now considered as terminals, or a prefix up to a non-terminal of $G$, which is replaced by its tagged non-terminal counterpart in $G'$.
\end{itemize}

\newcommand\VP{\text{VP}}
The language $\VP = L(G')$ is the set of the viable prefixes of the right sentential forms of $G$, or simply the ``viable prefixes''. This set is regular (it is generated by a right-regular grammar), and closed by prefixes ($\alpha\beta \in \VP \implies \alpha \in \VP$).

Also, if $\alpha B \in \VP$ and $B \rightarrow \beta \in R$, then $\alpha\beta \in \VP$: viable prefixes are closed by expansion of their last non-terminal. This property will be broken by the conflict resolution procedure of LR parsers.


\subsection{Reduction relation}

If a stack has the form $\gamma \alpha$ and $\gamma A \in \VP$, a shift-reduce parser is allowed to reduce the rule $A \rightarrow \alpha$, replacing the $\alpha$ suffix by $A$.
The parser reaches a new configuration with the stack $\gamma A$, from which new reductions might be possible. Thus the process may repeat an arbitrary number of times, though it will always terminate if the grammar is free of $\epsilon-$loops.

\newcommand\dred[3]{{(#1) #2 \downarrow #3}}
The composite actions of all these reductions will be to replace a stack of the form $\alpha \beta$ by a stack $\alpha \vec A$. Multiple non-terminals can appear on the right-hand side because of $\epsilon-$rules. To precisely characterize these actions, we define $\dred{\alpha}{\beta}{\vec A}$ as the least relation satisfying these rules:

\newcommand\Rule[3]{\frac{#1}{#2}\text{\small \ (#3)}}

\[\Rule
  {\alpha \in \VP}
  {\dred{\alpha}{\epsilon}{\epsilon}}
  {red-base}
\]

\[\Rule
  {\dred{\alpha\beta}{\gamma}{\vec C}
    \quad \beta \neq \epsilon
    \quad A \rightarrow \beta \vec C
    \quad \alpha A \in \VP}
  {\dred{\alpha}{\beta\gamma}{A}}
  {red-outer}
\]

\[\Rule
  {\dred{\alpha}{\beta}{\vec A \vec C}
    \quad A \rightarrow \vec B
    \quad\alpha \vec A B \in \VP}
  {\dred{\alpha}{\beta}{\vec A B}}
  {red-inner}
\]

\begin{description}
  \item[red-base:] any viable prefix can be the start of a sequence of reduction
  \item[red-outer:] a reduction can consume symbols from the original stack (if its right-hand side is longer than the new suffix)
  \item[red-inner:] a reduction that consumes only non-terminals and is not longer than the new suffix can directly replace it without consuming symbol from the stack
\end{description}

This characterization of the action of reductions on stacks will play an important role to reason {\em modulo reductions} when matching regular expressions and for enumerating ``failing stacks'', to generate a DFA and to very its coverage.

% TODO Utiliser les mêmes lettres pour les règles dans red-inner et red-outer, par exemple A -> \vec B dans red-outer.
% Peut-on séparer la règle red-outer en deux : (\alpha\beta)\gamma | c -> (\alpha)\beta\gamma | c
% Discuter du cas particulier où on n'a pas d'espilon-production.

\subsection{Regular expressions}

Syntax:
\[
\begin{array}{rrl}
  e \in RE &::=& \epsilon\ |\ x
  \\  &|& e_1 e_2 \ |\ e_1 | e_2 \ |\ e^*
  \\  &|& /A \rightarrow \alpha.\beta
  \\  &|& [e]
\end{array}
\]

\subsubsection{Matching semantics}

\newcommand\dre[3]{(#1) #2 \in #3}

\[
\Rule{}
     {\dre{\alpha}{\epsilon}{\epsilon}}
     {m-$\epsilon$}
\qquad
\Rule{}
     {\dre{\alpha}{x}{x}}
     {m-sym}
\qquad
\Rule{\dre{\alpha}{\beta}{e_1}\quad\dre{\alpha\beta}{\gamma}{e_2}}
     {\dre{\alpha}{\beta\gamma}{e_1e_2}}
     {m-seq}
\]
\[
\Rule{\dre{\alpha}{\beta}{e_1}}
     {\dre{\alpha}{\beta}{e_1|e_2}}
     {m-disj-l}
\qquad
\Rule{\dre{\alpha}{\beta}{e_2}}
     {\dre{\alpha}{\beta}{e_1|e_2}}
     {m-disj-r}
\qquad
\Rule{\dre{\alpha}{\beta}{\epsilon|ee^*}}
     {\dre{\alpha}{\beta}{e^*}}
     {m-star}
\]
\[
\Rule{A \rightarrow \beta \gamma \in R \quad \alpha A \in VP}
     {\dre{\alpha\beta}{\epsilon}{/A\rightarrow \beta.\gamma}}
     {m-item}
\qquad
\Rule{\dre{\alpha}{\vec{B}}{e} \quad \dred{\alpha}{\beta}{\vec B}}
     {\dre{\alpha}{\beta}{[e]}}
     {m-red}
\]


\subsubsection{Adding captures and disambiguation}

\[
\begin{array}{rrl}
  e &::=& \ldots
  \\  &|& v=e
  \\  &|& e^{*\!*}
  \\  &|& [\![e]\!]
\end{array}
\]

Let $v \in V$ be a set of variable names.
The construction $v=e$ is a capture. It associates the range of the input that matched a particular expression to the name $v$.

To give an interpretation to these captures, we introduce the valuations $\rho \in V \rightharpoonup \mathbb{N}\times\mathbb{N}$.
A valuation is a partial function from a variable name to a pair of integers $(pos,len)$, $pos$ being the position of the input where the match begins and $len$ the length of the match.

Valuations are constructed using three components:
\begin{itemize}
  \item $\emptyset$ is the valuation with an empty domain
  \item $v \mapsto (pos,len)$ is a singleton valuation defined only on $v$
  \item $\rho_3 = \rho_1 \uplus \rho_2$ is the left-leaning union: $\rho_3(v) = \rho_1(v)$ if $v \in dom(\rho_1)$ else $\rho_3(v)= \rho_2(v)$ if $v \in dom(\rho_2)$.
\end{itemize}

Captures make matching ambiguous: different valuations can be extracted from an expression matching an input. For instance, the expression $(x(v=y)|(v=x)y)$ matches $xy$ with the valuations $v\mapsto(0,1)$ and $v\mapsto(1,1)$.

We resolve these ambiguities by ordering solutions while extending the input language to give a bit of control on the resolution.
Informally, in case of ambiguity we define the disjunction $|$ to favor its left-hand side, the concatenation to favor its right-hand side, $.^{*}$ and $[.]$ to favor the shortest matching input and we introduce the variants $.^{**}$ and $[\![.]\!]$ for the longest matching input.

For instance, when matching $(a=(x|\epsilon))(b=(x|\epsilon))$ against $x$, the valuation $\{a\mapsto(0,0),b\mapsto(0,1)\}$ is preferred
(matching the right-hand side of the first disjunction and the left-hand side of the second one): even if we said that ambiguities with disjunction should be resolved in favor of the left branch, it is not possible to do so for both disjunctions at the same time and the rule of concatenation applies: the right disjunction has the priority. This semantics is unusual; POSIX, for instance, mandates a ``leftmost'' disambiguation strategy. However with an LR stack, the most relevant information will be found close to the top of the stack, on the right, while we get to less specific information as we get closer to the root of the stack. Thus, we favor the rightmost captures. Most expressions will simply ignore the prefix of the stack, identifying the context by looking at the first few rightmost states.

Furthermore, when matching from left-to-right, leftmost strategies lend themselves to greedy implementations that lead to smaller DFA (add REF to posix disambiguation). Our implementation will match from right-to-left, so a rightmost disambiguation strategy will offer the same benefits.

Formally, the ordering is specified by keeping a trace $t \in \text{Tr} = \{0,1\}^*$ along the derivation, and picking the minimal trace according to $<_\text{Tr}$, a {\em right-to-left} lexical ordering:

\[
\frac{}{t_10 <_\text{Tr} t_21}
\quad
\frac{t_1 <_\text{Tr} t_2}{t_10 <_\text{Tr} t_20}
\quad
\frac{t_1 <_\text{Tr} t_2}{t_11 <_\text{Tr} t_21}
\]

\newpage

\newcommand\dcre[5]{(#1) #2 / #3\ @\ #4 \in #5}
The semantics are now given by a relation $\dcre{\alpha}{\beta}{\rho}{t}{e} \subset \Sigma^* \times \Sigma^* \times (V \rightharpoonup \mathbb{N}\times\mathbb{N}) \times \text{Tr} \times RE$:

\[
\Rule{}
     {\dcre{\alpha}{\epsilon}{\emptyset}{\epsilon}{\epsilon}}
     {c-$\epsilon$}
\qquad
\Rule{}
     {\dcre{\alpha}{x}{\emptyset}{\epsilon}{x}}
     {c-sym}
\qquad
\Rule{\dcre{\alpha}{\beta}{\rho_1}{t_1}\quad\dcre{\alpha\beta}{\gamma}{\rho_2}{t_2}{e_2}}
     {\dcre{\alpha}{\beta\gamma}{\rho_1\uplus\rho_2}{t_1t_2}{e_1e_2}}
     {c-seq}
\]
\[
\Rule{\dcre{\alpha}{\beta}{\rho}{t}{e_1}}
     {\dcre{\alpha}{\beta}{\rho}{t0}{e_1|e_2}}
     {c-disj-l}
\qquad
\Rule{\dcre{\alpha}{\beta}{\rho}{t}{e_2}}
     {\dcre{\alpha}{\beta}{\rho}{t1}{e_1|e_2}}
     {c-disj-r}
\]
\[
\Rule{\dcre{\alpha}{\beta}{\rho}{t}{\epsilon|ee^*}}
     {\dcre{\alpha}{\beta}{\rho}{t}{e^*}}
     {c-star-short}
\qquad
\Rule{\dcre{\alpha}{\beta}{\rho}{t}{ee^*|\epsilon}}
     {\dcre{\alpha}{\beta}{\rho}{t}{e^{**}}}
     {c-star-long}
\]
\[
\Rule{A \rightarrow \beta \gamma \in R \quad \alpha A \in VP}
     {\dcre{\alpha\beta}{\epsilon}{\emptyset}{\epsilon}{/A\rightarrow \beta.\gamma}}
     {c-item}
\]
\[
\qquad
\Rule{\dre{\alpha}{\vec{B}}{e} \quad \dred{\alpha}{\beta}{\vec{B}}}
     {\dcre{\alpha}{\beta}{\emptyset}{1^{|\beta|}0}{[e]}}
     {c-red-short}
\qquad
\Rule{\dre{\alpha}{\vec{B}}{e} \quad \dred{\alpha}{\beta}{\vec B}}
     {\dcre{\alpha}{\beta}{\emptyset}{0^{|\beta|}1}{[\![e]\!]}}
     {c-red-long}
\]

% TODO : Les traces pourraient plutôt être un arbre.

\end{document}
